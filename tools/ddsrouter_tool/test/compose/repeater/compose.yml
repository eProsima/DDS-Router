services:

  build_image:
    image: ddsrouter-repeater-ds
    # build:
    #   context: ..
    #   dockerfile: Dockerfile
    #   args:
    #     - BRANCH=${BRANCH}
    # image: ddsrouter_image
    networks:
      - cloud_edge_1_net

  ddsrouter_cloud:
    image: ddsrouter-repeater-ds
    container_name: ddsrouter_cloud
    depends_on:
      - build_image
    networks:
      cloud_edge_1_net:
        aliases:
            - ddsrouter_cloud.edge_1
      cloud_edge_2_net:
        aliases:
            - ddsrouter_cloud.edge_2
    volumes:
      - ./ddsrouter_cloud.yaml:/config.yaml
    command: ddsrouter -c /config.yaml

  ddsrouter_edge_1:
    image: ddsrouter-repeater-ds
    container_name: ddsrouter_edge_1
    depends_on:
      - build_image
      - ddsrouter_cloud
    networks:
      - cloud_edge_1_net
      - edge_1_net
    volumes:
      - ./ddsrouter_edge_1.yaml:/config.yaml
    command: ddsrouter -c /config.yaml

  pub_edge_1:
    image: ddsrouter-repeater-ds
    depends_on:
      - build_image
    networks:
      - edge_1_net
    command: install/BasicConfigurationExample/examples/cpp/dds/BasicConfigurationExample/BasicConfigurationExample publisher -i 3000

  sub_edge_1:
    image: ddsrouter-repeater-ds
    depends_on:
      - build_image
    networks:
      - edge_1_net
    command: install/BasicConfigurationExample/examples/cpp/dds/BasicConfigurationExample/BasicConfigurationExample subscriber

  ddsrouter_edge_2:
    image: ddsrouter-repeater-ds
    container_name: ddsrouter_edge_2
    depends_on:
      - build_image
      - ddsrouter_cloud
    networks:
      - cloud_edge_2_net
      - edge_2_net
    volumes:
      - ./ddsrouter_edge_2.yaml:/config.yaml
    command: ddsrouter -c /config.yaml

  sub_edge_2:
    image: ddsrouter-repeater-ds
    depends_on:
      - build_image
    networks:
      - edge_2_net
    command: install/BasicConfigurationExample/examples/cpp/dds/BasicConfigurationExample/BasicConfigurationExample subscriber

networks:
  edge_1_net:
  edge_2_net:
  cloud_edge_1_net:
  cloud_edge_2_net:
  default:
    driver: none